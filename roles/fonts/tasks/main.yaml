- name: Install Nerd Fonts (Mac)
  when: is_mac
  community.general.homebrew_cask:
    name:
      - font-fira-code-nerd-font
      - font-monaspace-nf
    state: present
  register: font_install_mac
  failed_when:
    - font_install_mac.failed
    - "'already installed' not in font_install_mac.msg | default('')"

- name: Install FiraCode Nerd Font (Linux)
  when: not is_mac
  block:
    - name: Install unzip
      become: "{{ should_become }}"
      ansible.builtin.package:
        name: unzip
        state: present
    
    - name: Create fonts directory
      become: "{{ should_become }}"
      ansible.builtin.file:
        path: /usr/local/share/fonts/FiraCodeNerdFont
        state: directory
        mode: '0755'
    
    - name: Check if font already installed
      ansible.builtin.stat:
        path: /usr/local/share/fonts/FiraCodeNerdFont/FiraCodeNerdFont-Regular.ttf
      register: font_check
    
    - name: Download and install FiraCode font
      when: not font_check.stat.exists
      block:
        - name: Download FiraCode Nerd Font
          ansible.builtin.get_url:
            url: "{{ fonts_firacode_url }}"
            dest: /tmp/FiraCode.zip
            mode: '0644'
        
        - name: Extract FiraCode Nerd Font
          become: "{{ should_become }}"
          ansible.builtin.unarchive:
            src: /tmp/FiraCode.zip
            dest: /usr/local/share/fonts/FiraCodeNerdFont
            remote_src: true
        
        - name: Refresh font cache
          become: "{{ should_become }}"
          ansible.builtin.command: fc-cache -fv
          changed_when: true
        
        - name: Cleanup downloaded zip
          ansible.builtin.file:
            path: /tmp/FiraCode.zip
            state: absent
  
  rescue:
    - name: Warn about font installation failure
      ansible.builtin.debug:
        msg: "WARNING: FiraCode font installation failed. Terminal may not display correctly."
    
    - name: Cleanup on failure
      ansible.builtin.file:
        path: /tmp/FiraCode.zip
        state: absent
      failed_when: false

- name: Install Monaspace Nerd Font (Linux)
  when: not is_mac
  block:
    - name: Create Monaspace fonts directory
      become: "{{ should_become }}"
      ansible.builtin.file:
        path: /usr/local/share/fonts/MonaspaceNerdFont
        state: directory
        mode: '0755'
    
    - name: Check if Monaspace font already installed
      ansible.builtin.stat:
        path: /usr/local/share/fonts/MonaspaceNerdFont/MonaspiceNeNerdFont-Regular.otf
      register: monaspace_check
    
    - name: Download and install Monaspace font
      when: not monaspace_check.stat.exists
      block:
        - name: Download Monaspace Nerd Font
          ansible.builtin.get_url:
            url: "{{ fonts_monaspace_url }}"
            dest: /tmp/Monaspace.zip
            mode: '0644'
        
        - name: Extract Monaspace Nerd Font
          become: "{{ should_become }}"
          ansible.builtin.unarchive:
            src: /tmp/Monaspace.zip
            dest: /usr/local/share/fonts/MonaspaceNerdFont
            remote_src: true
        
        - name: Refresh font cache
          become: "{{ should_become }}"
          ansible.builtin.command: fc-cache -fv
          changed_when: true
        
        - name: Cleanup downloaded zip
          ansible.builtin.file:
            path: /tmp/Monaspace.zip
            state: absent
  
  rescue:
    - name: Warn about Monaspace font installation failure
      ansible.builtin.debug:
        msg: "WARNING: Monaspace font installation failed."
    
    - name: Cleanup on failure
      ansible.builtin.file:
        path: /tmp/Monaspace.zip
        state: absent
      failed_when: false
