- name: Check if zellij is already installed
  ansible.builtin.command: which zellij
  register: zellij_exists
  changed_when: false
  failed_when: false

- name: Install zellij from package manager
  when: zellij_exists.rc != 0
  become: "{{ should_become }}"
  ansible.builtin.package:
    name: zellij
    state: present
  register: zellij_pkg_install
  failed_when: false

- name: Install zellij from GitHub releases
  when: 
    - zellij_exists.rc != 0
    - zellij_pkg_install.failed | default(false)
  block:
    - name: Set architecture facts
      set_fact:
        zellij_arch: "{{ 'x86_64' if ansible_architecture == 'x86_64' else 'aarch64' }}"
        zellij_os: "{{ 'apple-darwin' if ansible_system == 'Darwin' else 'unknown-linux-musl' }}"
    
    - name: Create .local/bin directory
      ansible.builtin.file:
        path: "{{ ansible_facts['user_dir'] }}/.local/bin"
        state: directory
        mode: '0755'
    
    - name: Download and extract zellij
      ansible.builtin.unarchive:
        src: "https://github.com/zellij-org/zellij/releases/latest/download/zellij-{{ zellij_arch }}-{{ zellij_os }}.tar.gz"
        dest: "{{ ansible_facts['user_dir'] }}/.local/bin"
        remote_src: yes
        mode: '0755'

- name: Create zellij config directory
  file:
    path: "{{ ansible_facts['user_dir'] }}/.config/zellij"
    state: directory
    mode: '0755'

- name: Symlink config.kdl
  file:
    src: "{{ playbook_dir }}/../roles/zellij/files/config.kdl"
    dest: "{{ ansible_facts['user_dir'] }}/.config/zellij/config.kdl"
    state: link
