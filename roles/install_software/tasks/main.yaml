- name: Print os_family
  debug:
    msg: "OS Family: {{ ansible_facts['os_family'] }}. Should Become: {{ should_become }}"

- name: Install Ripgrep
  become: "{{ should_become }}"
  ansible.builtin.package:
    name: ripgrep
    state: present
  register: ripgrep_install
  failed_when:
    - ripgrep_install.failed
    - "'nothing provides' not in ripgrep_install.msg | default('')"
    - "'No package matching' not in ripgrep_install.msg | default('')"
    - "'Unable to locate package' not in ripgrep_install.msg | default('')"

- name: Warn if ripgrep install failed
  when: ripgrep_install.failed | default(false)
  ansible.builtin.debug:
    msg: "WARNING: ripgrep not available in package manager. Please install manually."

- name: Install FiraCode Nerd Font (Mac)
  when: is_mac
  community.general.homebrew_cask:
    name: font-fira-code-nerd-font
    state: present
  register: font_install_mac
  failed_when:
    - font_install_mac.failed
    - "'already installed' not in font_install_mac.msg | default('')"

- name: Install FiraCode Nerd Font (Linux)
  when: not is_mac
  block:
    - name: Install unzip
      become: "{{ should_become }}"
      ansible.builtin.package:
        name: unzip
        state: present
    
    - name: Create fonts directory
      become: "{{ should_become }}"
      file:
        path: /usr/local/share/fonts/FiraCodeNerdFont
        state: directory
        mode: '0755'
    
    - name: Check if font already installed
      ansible.builtin.stat:
        path: /usr/local/share/fonts/FiraCodeNerdFont/FiraCodeNerdFont-Regular.ttf
      register: font_check
    
    - name: Download and install FiraCode font
      when: not font_check.stat.exists
      block:
        - name: Download FiraCode Nerd Font
          get_url:
            url: "{{ firacode_url }}"
            dest: /tmp/FiraCode.zip
            mode: '0644'
        
        - name: Extract FiraCode Nerd Font
          become: "{{ should_become }}"
          unarchive:
            src: /tmp/FiraCode.zip
            dest: /usr/local/share/fonts/FiraCodeNerdFont
            remote_src: yes
        
        - name: Refresh font cache
          become: "{{ should_become }}"
          command: fc-cache -fv
          changed_when: true
        
        - name: Cleanup downloaded zip
          file:
            path: /tmp/FiraCode.zip
            state: absent
  
  rescue:
    - name: Warn about font installation failure
      ansible.builtin.debug:
        msg: "WARNING: FiraCode font installation failed. Terminal may not display correctly."
    
    - name: Cleanup on failure
      file:
        path: /tmp/FiraCode.zip
        state: absent
      failed_when: false

- name: Install fzf
  become: "{{ should_become }}"
  ansible.builtin.package:
    name: fzf
    state: present
  ignore_errors: true

- name: Install zoxide
  become: "{{ should_become }}"
  ansible.builtin.package:
    name: zoxide
    state: present
  ignore_errors: true

- name: Install Neovim
  become: "{{ should_become }}"
  ansible.builtin.package:
    name: neovim
    state: present
  register: neovim_install
  failed_when:
    - neovim_install.failed
    - "'nothing provides' not in neovim_install.msg | default('')"
    - "'No package matching' not in neovim_install.msg | default('')"
    - "'Unable to locate package' not in neovim_install.msg | default('')"

- name: Warn if neovim install failed
  when: neovim_install.failed | default(false)
  ansible.builtin.debug:
    msg: "WARNING: neovim not available in package manager. Install manually or from source."

