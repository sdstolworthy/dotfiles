---
- name: Print os_family
  ansible.builtin.debug:
    msg: "OS Family: {{ ansible_facts['os_family'] }}. Should Become: {{ should_become }}"

- name: Install packages
  become: "{{ should_become }}"
  ansible.builtin.package:
    name:
      - neovim
    state: present
  register: install_software_packages_result
  failed_when: false

- name: Warn about failed package installations
  when: install_software_packages_result.failed | default(false)
  ansible.builtin.debug:
    msg: "WARNING: Failed to install packages: {{ install_software_packages_result.msg | default('unknown error') }}"

- name: Install cargo packages
  loop: "{{ install_software_cargo_packages }}"
  ansible.builtin.shell: |
    set -o pipefail
    . "{{ ansible_facts['user_dir'] }}/.cargo/env"
    cargo install {{ item }}
  args:
    creates: "{{ ansible_facts['user_dir'] }}/.cargo/bin/{{ item | regex_replace('^git-', '') }}"
    executable: /bin/bash
  register: install_software_cargo_result
  failed_when: false

- name: Warn about failed cargo installations
  loop: "{{ install_software_cargo_result.results }}"
  when: item.rc is defined and item.rc != 0
  ansible.builtin.debug:
    msg: "WARNING: Failed to install {{ item.item }}: {{ item.stderr | default('unknown error') }}"
