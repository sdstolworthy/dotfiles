---
- name: Install mise (Mac)
  when: is_mac
  community.general.homebrew:
    name: mise
    state: present

- name: Install mise (Linux)
  when: not is_mac
  ansible.builtin.get_url:
    url: https://mise.run
    dest: /tmp/mise_install.sh
    mode: '0755'
  register: language_managers_mise_download

- name: Execute mise installer (Linux)
  when: not is_mac and language_managers_mise_download is succeeded
  ansible.builtin.shell: |
    set -o pipefail
    /tmp/mise_install.sh
  args:
    creates: "{{ ansible_facts['user_dir'] }}/.local/bin/mise"
    executable: /bin/bash

- name: Create mise profile
  when: profile_profiled_directory is defined
  ansible.builtin.copy:
    src: mise.sh
    dest: "{{ profile_profiled_directory }}/mise.sh"
    mode: '0644'

- name: Install tools with mise
  loop: "{{ language_managers_mise_tools }}"
  ansible.builtin.shell: |
    set -o pipefail
    export PATH="$HOME/.local/bin:$PATH"
    mise use -g {{ item }}@latest
  args:
    executable: /bin/bash
  register: language_managers_mise_install
  changed_when: "'installed' in language_managers_mise_install.stdout"
